# badsmtp.sh

A script to 
* monitor Kerio's security.log for login failures
* remove matches that also appear in Kerio's audit.log with successful logins
* remove matches against a collection of whitelisted IPs
* Add the results to a packet filter list

Blocked IPs with no attempted accesses will be removed after 3 days (60 * 60 * 72 seconds)

## Preparation
1. Add these lines to [/etc/pf.conf](https://github.com/mmccarn/KerioMailServer/blob/master/etc/pf.conf)
```
table <blockips> persist file "/etc/pf.blocked.ip.conf"
block quick log proto tcp from <blockips> to any port 25
block quick log proto tcp from <blockips> to any port 465
block quick log proto tcp from <blockips> to any port 587
block quick log proto tcp from <blockips> to any port 110
block quick log proto tcp from <blockips> to any port 995
block quick log proto tcp from <blockips> to any port 143
block quick log proto tcp from <blockips> to any port 993
```

2. Create the peristent file for the blocklist
```
touch /etc/pf.blocked.ip.conf
```

3. Enable PF and Activate the new configuration
```
pfctl -e
pfctl -f /etc/pf.conf
```

## Installation
Download and run [badsmtp.sh](https://github.com/mmccarn/KerioMailServer/blob/master/var/root/bin/badsmtp.sh)
```
mkdir -p /var/root/bin
curl -s -L https://github.com/mmccarn/KerioMailServer/raw/master/var/root/bin/badsmtp.sh -o /var/root/bin/badsmtp.sh
chmod +x /var/root/bin/badsmtp.sh
#
# review the file to see what it does...
#
/var/root/bin/badsmtp.sh
```

## Scheduling
I scheduled the script to run every 10 minutes by root, logging to /var/root/badsmtp.log
```
sudo crontab -e
# add this line at the bottom (without the leading '#')
#  */10 * * * * /var/root/bin/badsmtp.sh -v >> /var/log/aicr-pf.log 2>&1
#
# save and exit
```

## Monitoring
* Updates using badsmtp.sh can be monitored by looking at /var/log/aicr-pf.log
* More detailed output can be generated by running badsmtp.sh with "-vv" or "-vvv" on the command line:
```
/var/root/bin/badsmtp.sh -vvv
```
* Read more about monitoring PF
[EmergingThreats - monitor performance](/EmergingThreats.md#monitor-performance)
